name: Node CI

env:
  DENO_VERSION: 1.0.2
  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  AWS_REGION: us-west-1

# Push tests commits; pull_request tests PR merges
on: [ push ]
# on: [ push, pull_request ]

jobs:

  # Test the build
  build:
    # Setup
    runs-on: ubuntu-latest

    # Go
    steps:
      - name: Check out repo
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v1
        with:
          node-version: 12

      - name: Env
        run: |
          echo Deno ver: $DENO_VERSION
          echo "Event name: ${{ github.event_name }}"
          echo "Git ref:    ${{ github.ref }}"
          echo "GH actor:   ${{ github.actor }}"
          echo "SHA:        ${{ github.sha }}"

      - name: Download & uncompress
        run: |
          curl -fsSL https://github.com/denoland/deno/releases/download/v$DENO_VERSION/deno_src.tar.gz --output deno.tar.gz
          tar -zxf deno.tar.gz

      - name: Build
        run: |
          cd deno/cli
          cargo install --locked --root .. --path .

      - name: Copy bin to S3
        run: aws s3 cp deno s3://begin-deno-runtime/deno-$DENO_VERSION

      - name: Publish layer
        run: node ./do-fun-stuff-here-brian

      - name: Notify
        uses: homoluctus/slatify@master
        if: always()
        with:
          type: ${{ job.status }}
          job_name: '*Deno build*'
          url: ${{ secrets.SLACK_WEBHOOK }}
          commit: true
          token: ${{ secrets.GITHUB_TOKEN }}
